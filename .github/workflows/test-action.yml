name: Test Action

on:
  push:
    branches: [main]
    paths:
      - 'action.yml'
      - 'src/**'
  pull_request:
    branches: [main]
    paths:
      - 'action.yml'
      - 'src/**'

permissions:
  contents: read

jobs:
  test-action-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'
      - name: Install from source
        run: pip install -e .
      - name: Run action (markdown + summary)
        id: estimate
        uses: ./
        with:
          issues: '2,3'
          format: markdown
          output-mode: summary
      - name: Verify report output
        env:
          AE_REPORT: ${{ steps.estimate.outputs.report }}
        run: |
          if [ -z "$AE_REPORT" ]; then
            echo "::error::report output is empty"
            exit 1
          fi
          echo "Report length: ${#AE_REPORT} chars"

  test-action-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'
      - name: Install from source
        run: pip install -e .
      - name: Run action (json + step-output)
        id: estimate
        uses: ./
        with:
          issues: '2,3'
          format: json
          output-mode: step-output
      - name: Verify JSON parses
        env:
          AE_REPORT: ${{ steps.estimate.outputs.report }}
        run: |
          echo "$AE_REPORT" | python -c "import sys,json; json.load(sys.stdin)" || {
            echo "::error::report output is not valid JSON"
            exit 1
          }
      - name: Verify expected-minutes is numeric
        env:
          AE_MINUTES: ${{ steps.estimate.outputs.expected-minutes }}
        run: |
          if [ -z "$AE_MINUTES" ]; then
            echo "::error::expected-minutes output is empty"
            exit 1
          fi
          python -c "float('$AE_MINUTES')" || {
            echo "::error::expected-minutes is not numeric: $AE_MINUTES"
            exit 1
          }
          echo "Expected minutes: $AE_MINUTES"
